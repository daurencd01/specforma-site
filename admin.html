<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî SpecForma.Almaty</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;
            --primary-light: #1e293b;
            --accent: #f97316;
            --accent-hover: #ea580c;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #334155;
            --text-muted: #64748b;
            --success: #22c55e;
            --error: #ef4444;
            --radius: 14px;
            --shadow: 0 4px 24px rgba(15, 23, 42, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
        .topbar {
            background: var(--primary);
            color: white;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        .topbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar-icon {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .topbar-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .topbar-sub {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .topbar-link {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-decoration: none;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .topbar-link:hover {
            color: white;
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .topbar-user {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.45);
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-logout {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            border-radius: 8px;
            padding: 7px 14px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            white-space: nowrap;
        }

        .btn-logout:hover {
            background: rgba(239, 68, 68, 0.28);
            color: #fecaca;
        }

        /* Auth guard: hide page content until session verified */
        #page-content {
            display: none;
        }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .page {
            max-width: 860px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }

        .page-heading {
            margin-bottom: 32px;
        }

        .page-heading h1 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .page-heading p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 36px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        label .required {
            color: var(--accent);
            margin-left: 2px;
        }

        label .optional {
            color: var(--text-muted);
            font-weight: 400;
            font-size: 0.8rem;
            margin-left: 4px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 11px 16px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: var(--text);
            background: #fafafa;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
            outline: none;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.12);
            background: white;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }

        /* ‚îÄ‚îÄ IMAGE UPLOAD ZONE ‚îÄ‚îÄ */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 36px 24px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            background: #fafafa;
            position: relative;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--accent);
            background: rgba(249, 115, 22, 0.04);
        }

        .upload-zone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .upload-icon {
            width: 56px;
            height: 56px;
            background: rgba(249, 115, 22, 0.1);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: var(--accent);
        }

        .upload-zone h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .upload-zone p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* ‚îÄ‚îÄ IMAGE PREVIEWS ‚îÄ‚îÄ */
        #image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }

        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--border);
            flex-shrink: 0;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s;
        }

        .preview-item .preview-remove:hover {
            background: var(--error);
        }

        .preview-item .preview-upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0, 0, 0, 0.2);
        }

        .preview-item .preview-upload-progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        /* ‚îÄ‚îÄ BADGE PREVIEW ‚îÄ‚îÄ */
        .badge-preview {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(249, 115, 22, 0.12);
            color: var(--accent);
            margin-top: 8px;
            min-height: 24px;
        }

        /* ‚îÄ‚îÄ SUBMIT BUTTON ‚îÄ‚îÄ */
        .btn-submit {
            width: 100%;
            padding: 16px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.15s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.25);
        }

        .btn-submit:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(249, 115, 22, 0.4);
        }

        .btn-submit:disabled {
            opacity: 0.65;
            cursor: not-allowed;
            transform: none;
        }

        .btn-submit .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
        #toast {
            position: fixed;
            bottom: 28px;
            right: 28px;
            padding: 14px 22px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
            transform: translateY(80px);
            opacity: 0;
            transition: transform 0.35s cubic-bezier(.34, 1.56, .64, 1), opacity 0.3s;
            z-index: 9999;
            max-width: 380px;
        }

        #toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        #toast.success {
            background: var(--success);
        }

        #toast.error {
            background: var(--error);
        }

        /* ‚îÄ‚îÄ UPLOAD PROGRESS BAR ‚îÄ‚îÄ */
        #upload-progress {
            display: none;
            margin-top: 14px;
            background: var(--border);
            border-radius: 99px;
            height: 6px;
            overflow: hidden;
        }

        #upload-progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.4s;
            border-radius: 99px;
        }

        #upload-status {
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-top: 6px;
            display: none;
        }

        /* ‚îÄ‚îÄ PRODUCTS LIST ‚îÄ‚îÄ */
        .product-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .product-list-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: box-shadow 0.2s;
        }

        .product-list-item:hover {
            box-shadow: var(--shadow);
        }

        .product-list-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .product-list-info {
            padding: 14px;
        }

        .product-list-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .product-list-price {
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 500;
        }

        .product-list-cat {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .btn-delete {
            width: 100%;
            padding: 8px;
            background: none;
            border: 1px solid #fecaca;
            color: var(--error);
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #fef2f2;
        }

        .empty-list {
            grid-column: 1/-1;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 600px) {
            .topbar {
                padding: 14px 16px;
            }

            .page {
                padding: 24px 16px 60px;
            }

            .card {
                padding: 24px 18px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-brand">
            <div class="topbar-icon">‚öôÔ∏è</div>
            <div>
                <div class="topbar-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
                <div class="topbar-sub">SpecForma.Almaty</div>
            </div>
        </div>
        <div class="topbar-actions">
            <span class="topbar-user" id="admin-email"></span>
            <a href="catalog.html" class="topbar-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
                –ù–∞ —Å–∞–π—Ç
            </a>
            <button class="btn-logout" id="logout-btn">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                –í—ã–π—Ç–∏
            </button>
        </div>
    </div>

    <div class="page" id="page-content">

        <div class="page-heading">
            <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h1>
            <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏ —É–¥–∞–ª—è–π—Ç–µ —Ç–æ–≤–∞—Ä—ã ‚Äî –æ–Ω–∏ —Å—Ä–∞–∑—É –ø–æ—è–≤—è—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.</p>
        </div>

        <!-- Add Product Form -->
        <div class="card">
            <div class="card-title">
                <div class="card-title-dot"></div>
                –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
            </div>

            <form id="product-form" novalidate>

                <div class="form-row">
                    <div class="form-group">
                        <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ <span class="required">*</span></label>
                        <input type="text" id="name" placeholder="–ö–æ—Å—Ç—é–º —Ä–∞–±–æ—á–∏–π ¬´–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç¬ª" required>
                    </div>
                    <div class="form-group">
                        <label for="price">–¶–µ–Ω–∞ (‚Ç∏) <span class="optional">‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</span></label>
                        <input type="number" id="price" placeholder="12500" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è <span class="required">*</span></label>
                        <select id="category" required>
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <option value="clothes">–°–ø–µ—Ü–æ–¥–µ–∂–¥–∞</option>
                            <option value="siz">–ó–∏–º–Ω—è—è —Å–ø–µ—Ü–æ–¥–µ–∂–¥–∞</option>
                            <option value="shoes">–°–ø–µ—Ü–æ–±—É–≤—å</option>
                            <option value="accessories">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="badge">–ë–µ–π–¥–∂ <span class="optional">‚Äî –Ω–∞–ø—Ä. ¬´–•–∏—Ç –ø—Ä–æ–¥–∞–∂¬ª</span></label>
                        <input type="text" id="badge" placeholder="–•–∏—Ç –ø—Ä–æ–¥–∞–∂">
                        <div class="badge-preview" id="badge-preview"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="description"
                        placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –º–∞—Ç–µ—Ä–∏–∞–ª, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..."></textarea>
                </div>

                <!-- Image Upload -->
                <div class="form-group">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞ <span class="required">*</span> <span class="optional">‚Äî –¥–æ 10 —Ñ–∞–π–ª–æ–≤,
                            JPG/PNG/WEBP</span></label>
                    <div class="upload-zone" id="upload-zone">
                        <input type="file" id="images" accept="image/*" multiple>
                        <div class="upload-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <polyline points="21 15 16 10 5 21" />
                            </svg>
                        </div>
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</h3>
                        <p>JPG, PNG, WEBP ‚Äî –º–∞–∫—Å–∏–º—É–º 5 –ú–ë –∫–∞–∂–¥—ã–π</p>
                    </div>
                    <div id="image-preview"></div>

                    <!-- Upload Progress -->
                    <div id="upload-progress">
                        <div id="upload-progress-bar"></div>
                    </div>
                    <div id="upload-status"></div>
                </div>

                <button type="submit" class="btn-submit" id="submit-btn">
                    <div class="spinner" id="spinner"></div>
                    <svg id="submit-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    <span id="submit-text">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</span>
                </button>

            </form>
        </div>

        <!-- Products List -->
        <div class="card">
            <div class="card-title">
                <div class="card-title-dot"></div>
                –¢–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                <span id="product-count"
                    style="margin-left: auto; font-size:0.8rem; color: var(--text-muted); font-weight:400;"></span>
            </div>
            <div class="product-list-grid" id="products-list">
                <div class="empty-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

    </div>

    <!-- Toast -->
    <div id="toast">
        <span id="toast-message"></span>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabaseUrl = "https://hdkdxtotusteqqbvhloi.supabase.co";
        const supabaseKey = "sb_publishable_9pKEOQ3uBNK-XK4dxk8SlA_1RQrROSj";
        const supabase = createClient(supabaseUrl, supabaseKey);

        // ‚îÄ‚îÄ Module-level flags (must be declared BEFORE the async auth guard) ‚îÄ‚îÄ
        const BUCKET = "products";
        let isAdmin = false;

        // ‚îÄ‚îÄ Auth Guard: check session + role before showing anything ‚îÄ‚îÄ
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            // Not logged in at all
            window.location.replace('admin-login.html');
        } else {
            const role = session.user.user_metadata?.role;

            if (role !== 'admin') {
                // Logged in but NOT admin
                console.warn('Access denied: user does not have admin role.');
                await supabase.auth.signOut();
                window.location.replace('/');
            } else {
                // ‚úÖ Authenticated + admin role confirmed
                isAdmin = true;

                // Show page content
                document.getElementById('page-content').style.display = 'block';

                // Show admin email in topbar
                const emailEl = document.getElementById('admin-email');
                if (emailEl) emailEl.textContent = session.user.email;

                // Init page data
                loadProducts();
            }
        }

        // ‚îÄ‚îÄ Watch for session changes (e.g. token expiry) ‚îÄ‚îÄ
        supabase.auth.onAuthStateChange((event, newSession) => {
            if (event === 'SIGNED_OUT' || !newSession) {
                window.location.replace('admin-login.html');
            }
        });

        // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ
        document.getElementById('logout-btn').addEventListener('click', async () => {
            isAdmin = false;
            await supabase.auth.signOut();
            window.location.replace('admin-login.html');
        });


        // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.className = `show ${type}`;
            setTimeout(() => { toast.className = ''; }, 4000);
        }

        // ‚îÄ‚îÄ Badge preview ‚îÄ‚îÄ
        document.getElementById('badge').addEventListener('input', function () {
            document.getElementById('badge-preview').textContent = this.value;
        });

        // ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ
        const zone = document.getElementById('upload-zone');
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        // collected File objects
        let selectedFiles = [];

        document.getElementById('images').addEventListener('change', function () {
            handleFiles(this.files);
            this.value = ''; // reset so same files can be re-added
        });

        function handleFiles(fileList) {
            Array.from(fileList).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                if (selectedFiles.length >= 10) { showToast('–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ', 'error'); return; }
                selectedFiles.push(file);
                renderPreview(file, selectedFiles.length - 1);
            });
        }

        function renderPreview(file, index) {
            const preview = document.getElementById('image-preview');
            const reader = new FileReader();
            reader.onload = (e) => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                item.dataset.index = index;
                item.innerHTML = `
                    <img src="${e.target.result}" alt="">
                    <button type="button" class="preview-remove" title="–£–±—Ä–∞—Ç—å">√ó</button>
                    <div class="preview-upload-progress"><div class="preview-upload-progress-bar"></div></div>`;
                item.querySelector('.preview-remove').addEventListener('click', () => {
                    selectedFiles.splice(index, 1);
                    // Re-index remaining
                    item.remove();
                    document.querySelectorAll('.preview-item').forEach((el, i) => el.dataset.index = i);
                });
                preview.appendChild(item);
            };
            reader.readAsDataURL(file);
        }

        // ‚îÄ‚îÄ Upload images to Storage ‚îÄ‚îÄ
        async function uploadImages(files) {
            const urls = [];
            const progressEl = document.getElementById('upload-progress');
            const barEl = document.getElementById('upload-progress-bar');
            const statusEl = document.getElementById('upload-status');

            progressEl.style.display = 'block';
            statusEl.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const ext = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 8)}.${ext}`;
                const path = `${fileName}`;

                statusEl.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${i + 1} –∏–∑ ${files.length}: ${file.name}`;

                const { data, error } = await supabase.storage
                    .from(BUCKET)
                    .upload(path, file, { cacheControl: '3600', upsert: false });

                if (error) {
                    showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${error.message}`, 'error');
                    continue;
                }

                const { data: urlData } = supabase.storage.from(BUCKET).getPublicUrl(path);
                urls.push(urlData.publicUrl);

                // Update per-image progress bar
                const previewBar = document.querySelector(`.preview-item[data-index="${i}"] .preview-upload-progress-bar`);
                if (previewBar) previewBar.style.width = '100%';

                // Overall progress
                barEl.style.width = `${Math.round(((i + 1) / files.length) * 100)}%`;
            }

            statusEl.textContent = urls.length === files.length ? '‚úì –í—Å–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã' : `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${urls.length} –∏–∑ ${files.length}`;
            return urls;
        }

        // ‚îÄ‚îÄ Form Submit ‚îÄ‚îÄ
        document.getElementById('product-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const name = document.getElementById('name').value.trim();
            const category = document.getElementById('category').value;
            const price = document.getElementById('price').value;
            const description = document.getElementById('description').value.trim();
            const badge = document.getElementById('badge').value.trim();

            if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'error'); return; }
            if (!category) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error'); return; }
            if (selectedFiles.length === 0) { showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ', 'error'); return; }

            // ‚îÄ‚îÄ Role guard ‚îÄ‚îÄ
            if (!isAdmin) {
                console.warn('Access denied: insert blocked ‚Äî not admin.');
                showToast('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
                return;
            }

            // Loading state
            const btn = document.getElementById('submit-btn');
            const spinner = document.getElementById('spinner');
            const submitIcon = document.getElementById('submit-icon');
            const submitText = document.getElementById('submit-text');

            btn.disabled = true;
            spinner.style.display = 'block';
            submitIcon.style.display = 'none';
            submitText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...';

            try {
                // 1. Upload images
                const imageUrls = await uploadImages(selectedFiles);

                if (imageUrls.length === 0) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ');
                }

                submitText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...';

                // 2. Insert into products table
                const { error } = await supabase.from('products').insert([{
                    name,
                    category,
                    price: price ? parseFloat(price) : null,
                    description: description || null,
                    badge: badge || null,
                    images: imageUrls,
                }]);

                if (error) throw error;

                // Success
                showToast('‚úì –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                resetForm();
                loadProducts(); // Refresh list

            } catch (err) {
                console.error(err);
                showToast(`–û—à–∏–±–∫–∞: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
                submitIcon.style.display = 'block';
                submitText.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            }
        });

        function resetForm() {
            document.getElementById('product-form').reset();
            document.getElementById('image-preview').innerHTML = '';
            document.getElementById('badge-preview').textContent = '';
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-progress-bar').style.width = '0%';
            document.getElementById('upload-status').style.display = 'none';
            selectedFiles = [];
        }

        // ‚îÄ‚îÄ Load Existing Products ‚îÄ‚îÄ
        async function loadProducts() {
            const listEl = document.getElementById('products-list');
            const countEl = document.getElementById('product-count');

            if (!listEl) {
                console.error('[Admin] #products-list element not found in DOM');
                return;
            }

            listEl.innerHTML = '<div class="empty-list">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
            console.log('[Admin] loadProducts() started, isAdmin =', isAdmin);

            // Verify Supabase client is ready
            if (!supabase) {
                console.error('[Admin] supabase client is undefined!');
                listEl.innerHTML = '<div class="empty-list" style="color:var(--error)">–û—à–∏–±–∫–∞: Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</div>';
                return;
            }

            // Re-check session for extra safety
            const { data: { session: currentSession } } = await supabase.auth.getSession();
            if (!currentSession) {
                console.warn('[Admin] loadProducts: no active session, redirecting...');
                window.location.replace('admin-login.html');
                return;
            }

            console.log('[Admin] Fetching from table: products...');

            const { data, error } = await supabase
                .from('products')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('[Admin] Supabase error fetching products:', error.code, error.message, error.details);

                let hint = '';
                if (error.code === '42P01') hint = ' (—Ç–∞–±–ª–∏—Ü–∞ "products" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –µ—ë –≤ Supabase)';
                if (error.code === '42501') hint = ' (–Ω–µ—Ç –ø—Ä–∞–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏)';
                if (error.message?.includes('permission denied')) hint = ' (permission denied ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ RLS)';
                if (error.message?.includes('JWT')) hint = ' (–æ—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞ ‚Äî –≤—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞)';

                listEl.innerHTML = `<div class="empty-list" style="color:var(--error); text-align:left; padding: 20px;">
                    <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</strong><br>
                    <code style="font-size:0.8rem; opacity:0.8;">${error.code}: ${error.message}${hint}</code>
                </div>`;
                return;
            }

            console.log('[Admin] Products fetched:', data?.length ?? 0, 'items');

            if (countEl) countEl.textContent = data.length ? `${data.length} —Ç–æ–≤–∞—Ä–æ–≤` : '';

            if (!data || data.length === 0) {
                listEl.innerHTML = '<div class="empty-list">–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>';
                return;
            }

            listEl.innerHTML = '';
            data.forEach(product => {
                let images = [];
                try { images = Array.isArray(product.images) ? product.images : JSON.parse(product.images || '[]'); }
                catch { images = []; }

                const thumb = images[0] || 'https://via.placeholder.com/200x200?text=No+Image';
                const price = product.price ? `${Number(product.price).toLocaleString('ru')} ‚Ç∏` : '–ü–æ –∑–∞–ø—Ä–æ—Å—É';
                const catLabel = { clothes: '–°–ø–µ—Ü–æ–¥–µ–∂–¥–∞', siz: '–ó–∏–º–Ω—è—è', shoes: '–°–ø–µ—Ü–æ–±—É–≤—å', accessories: '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã' }[product.category] || product.category;

                const item = document.createElement('div');
                item.className = 'product-list-item';
                item.innerHTML = `
                    <img src="${thumb}" alt="${product.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/200x200?text=–ù–µ—Ç+—Ñ–æ—Ç–æ'">
                    <div class="product-list-info">
                        <div class="product-list-name">${product.name}</div>
                        <div class="product-list-price">${price}</div>
                        <div class="product-list-cat">${catLabel} ¬∑ ${images.length} —Ñ–æ—Ç–æ</div>
                        <button class="btn-delete" data-id="${product.id}">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;

                // ‚îÄ‚îÄ Delete button with role guard ‚îÄ‚îÄ
                item.querySelector('.btn-delete').addEventListener('click', async () => {
                    if (!isAdmin) {
                        console.warn('Access denied: delete blocked ‚Äî not admin.');
                        showToast('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤', 'error');
                        return;
                    }
                    if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${product.name}"?`)) return;
                    const { error: delErr } = await supabase.from('products').delete().eq('id', product.id);
                    if (delErr) {
                        console.error('[Admin] Delete error:', delErr);
                        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + delErr.message, 'error');
                        return;
                    }
                    showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω', 'success');
                    item.remove();
                    const remaining = listEl.querySelectorAll('.product-list-item').length;
                    if (countEl) countEl.textContent = remaining ? `${remaining} —Ç–æ–≤–∞—Ä–æ–≤` : '';
                    if (!remaining) listEl.innerHTML = '<div class="empty-list">–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>';
                });

                listEl.appendChild(item);
            });

            console.log('[Admin] Products rendered successfully.');
        }

        // loadProducts() is called inside the auth session check above.
    </script>

</body>

</html>